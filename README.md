# Shloka Module

Модуль для автоматизации управления иерархической структурой священных текстов в Drupal 11.

## Требования

- Drupal 11.x
- PHP 8.3+
- Модули:
  - Book
  - Menu UI
  - Menu Tree (https://www.drupal.org/project/menu_tree)
  - Pathauto
  - Content Translation

## Предварительная подготовка

### Типы контента

Перед установкой модуля необходимо создать следующие типы контента:

- **bg_chapter** - Главы Бхагавад-гиты
- **sb_song** - Песни Шримад-Бхагаватам
- **sb_chapter** - Главы Шримад-Бхагаватам
- **cc_lila** - Лилы Чайтанья-Чаритамриты
- **cc_chapter** - Главы Чайтанья-Чаритамриты

Типы контента для стихов (bg, sb, cc) должны уже существовать в системе.

## Установка

1. Поместите модуль в директорию `/modules/custom/shloka`
2. Включите модуль через Drush:
   ```bash
   drush en shloka
   ```
   или через административный интерфейс Drupal

3. Очистите кеш:
   ```bash
   drush cr
   ```

4. Перейдите в настройки модуля: `/admin/config/content/shloka`

## Первоначальная настройка

### 1. Создание главных страниц книг

Вручную создайте главные страницы для каждой книги (тип контента Page или любой другой):
- Бхагавад-гита
- Шримад-Бхагаватам
- Чайтанья-Чаритамрита

Запомните ID этих страниц (число в URL вида `/node/2523`).

### 2. Конфигурация

1. Перейдите в `/admin/config/content/shloka`
2. В разделе "Конфигурация" укажите ID созданных главных страниц:
   - ID главной страницы БГ
   - ID главной страницы ШБ
   - ID главной страницы ЧЧ
3. Нажмите "Сохранить конфигурацию"

### 3. Создание структуры

Для каждой книги выполните следующие шаги:

#### Бхагавад-гита (БГ)
1. Нажмите "Создать главы БГ" - создаст 18 глав
2. Нажмите "Подчинить стихи БГ главам" - привяжет существующие стихи к главам

#### Шримад-Бхагаватам (ШБ)
1. Нажмите "Создать песни ШБ" - создаст 12 песен с главами
2. Нажмите "Подчинить стихи ШБ главам" - привяжет существующие стихи к главам

#### Чайтанья-Чаритамрита (ЧЧ)
1. Нажмите "Создать лилы ЧЧ" - создаст 3 лилы с главами
2. Нажмите "Подчинить стихи ЧЧ главам" - привяжет существующие стихи к главам

### 4. Синхронизация меню

После создания всей структуры нажмите "Синхронизировать меню navigaciya" для обновления навигации.

## Структура контента

### Иерархия

- **Бхагавад-гита:** Книга → Глава (18) → Стихи
- **Шримад-Бхагаватам:** Книга → Песня (12) → Глава → Стихи
- **Чайтанья-Чаритамрита:** Книга → Лила (3) → Глава → Стихи

### Алиасы URL

- БГ: `/books/bg/[глава]/[стих]`
- ШБ: `/books/sb/[песня]/[глава]/[стих]`
- ЧЧ: `/books/cc/[лила]/[глава]/[стих]`

### Поля типов контента

Модуль автоматически создаст необходимые поля при установке:
- `field_number` - номер главы/песни/лилы
- `field_title` - заголовок
- `field_book_ref` - ссылка на книгу (для bg_chapter)
- `field_song_ref` - ссылка на песню (для sb_chapter)
- `field_lila_ref` - ссылка на лилу (для cc_chapter)

## Отображение контента

### Страницы глав

На страницах глав автоматически выводятся:
- Заголовок стиха (field_title) как ссылка на страницу стиха
- Текст перевода (field_translate) с удалением слов "TRANSLATION" и "ПЕРЕВОД"
- Формат: **BG 1.1:** Текст перевода...
- Стихи разделены двойным переносом строки

### Особенности

- Поддержка составных стихов (например, 5-8)
- Мультиязычность - выводится перевод на текущем языке интерфейса
- Точная фильтрация - только стихи текущей главы
- Сортировка по номеру стиха

## Удаление структуры

Для полного удаления структуры книги используйте соответствующие кнопки "Удалить структуру". Это удалит:
- Все главы/песни/лилы
- Связи в Book outline
- Алиасы URL
- Пункты меню

**Важно:** Сами стихи НЕ удаляются, только их привязка к структуре.

## Известные проблемы и решения

### Ошибка "Duplicate entry" при подчинении стихов

Если при выполнении операции "Подчинить стихи главам" возникает ошибка вида:
```
SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry 'XXX' for key 'book.PRIMARY'
```

Это означает, что стихи уже были ранее добавлены в Book outline. Модуль автоматически удаляет существующие записи перед созданием новых, но если ошибка все же возникает:

1. Очистите кеш: `drush cr`
2. Попробуйте операцию снова
3. Если проблема сохраняется, проверьте таблицу `book` в базе данных

### Важные замечания

- **Повторное подчинение стихов**: Операцию "Подчинить стихи главам" можно выполнять многократно - существующие записи будут обновлены
- **Изменение структуры**: При изменении иерархии (например, перемещении стиха в другую главу) необходимо заново запустить подчинение стихов

## Техническая информация

### Сервисы

- `shloka.book_structure_manager` - управление структурой книг
- `shloka.chapter_renderer` - рендеринг содержимого глав

### Хуки

- `hook_ENTITY_TYPE_view()` - автоматический вывод стихов на страницах глав
- `hook_entity_presave()` - автоматическая привязка к Book outline
- `hook_theme()` - определение темы для вывода стихов

### Batch операции

Все массовые операции (создание глав, подчинение стихов) выполняются через Batch API для избежания таймаутов. При подчинении стихов:
- Существующие записи в Book outline автоматически удаляются
- Создаются новые записи с правильной иерархией
- Операция идемпотентна - можно запускать многократно

## Поддержка

При возникновении проблем:
1. Проверьте логи Drupal в `/admin/reports/dblog`
2. Убедитесь в наличии всех зависимостей
3. Проверьте правильность ID главных страниц
4. Очистите кеш сайта
